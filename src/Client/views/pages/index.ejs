<!DOCTYPE html>
<html dir="rtl">
<head>
    <title>VCS Demo</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
    <script src="https://cdn.geogebra.org/apps/deployggb.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" type="text/css" href="/style.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
</head>
<body>
<header>
    <% include ../partials/header %>
</header>
<script>
    var _strings;
    var _user;
    var _isLocked = true;

    $.getJSON("/Lang/heb.json", function(json) {
        _strings = json;
        initText();
    });

    function initText() {
        $("#btnControl").html(_strings.takeControl);
        $('#userInControl').html(_strings.noOneInControl);
    }

    var socket = io();
    function setListenerToUpdate() {
        socket.on('update',function(data) {
            var applet = document.ggbApplet;
            if(data !== undefined && data !== null)
                applet.setBase64(data);
        });

        socket.on('lockFromServer',function(user) {
            putUserInControl(user);
        });

        socket.on('releaseFromServer',function(user) {
            releaseUserControl(user);
        });

        socket.emit('ready', "ok");
    }



    var parameters = {
        "id":"ggbApplet",
        "width":$(window).width() * 0.8,
        "height": $(window).height() * 0.82,
        "showToolBar":true,
        "borderColor":null,
        "showMenuBar":false,
        "allowStyleBar":true,
        "showAlgebraInput":true,
        "enableLabelDrags":false,
        "enableShiftDragZoom":true,
        "capturingThreshold":null,
        "showToolBarHelp":true,
        "language":"iw",
        "country":"IL",
        "errorDialogsActive":true,
        "showTutorialLink":false,
        "showLogging":false,
        "useBrowserForJS":true,
        "perspective":"AG"};

    var applet = new GGBApplet(parameters, '5.0', 'applet_container');

    window.onload = function() {
        applet.inject('applet_container');
    }

    function ggbOnInit() {
        var board = document.ggbApplet;
        board.registerAddListener("addListener");
//        applet.registerRemoveListener("event");
//        applet.registerRenameListener("event");
//        applet.registerClearListener("event");
//        applet.registerUpdateListener("event");
        setListenerToUpdate();
    }
    
    function addListener(objName) {
        console.log(objName);
//        var toExport = applet.getBase64();
//        socket.emit('update', toExport);
        //console.log("yakir");
    }


    function putUserInControl(userInControl) {
        if(_user != userInControl)
            $('#btnControl').attr("disabled", true);
        $('#userInControl').html(userInControl + " " + _strings.inControl);
    }

    function releaseUserControl(user) {
        $('#btnControl').attr("disabled", false);
        $('#userInControl').html(_strings.noOneInControl);
    }

    function lockBoard(lock) {
        if(!lock) { // _user release control
            socket.emit('releaseFromClient', _user);
            releaseUserControl();
            $("#applet_container").addClass("disabledbutton");
            _isLocked = true;
            $("#btnControl").html(_strings.takeControl);
        }
        else { // _user take control
            _user = $("#name").val();
            socket.emit('lockFromClient', _user);
            putUserInControl(_user);
            $("#applet_container").removeClass("disabledbutton");
            _isLocked = false;
            $("#btnControl").html(_strings.release);
        }
    }

</script>
<div class="toolBar">
    <input id="name" type="text" placeholder="הכנס את שמך">
    <button id="btnControl" type="button" onclick="lockBoard(_isLocked)" class="btn btn-success">loading..</button>
    <span id="userInControl" style="width: 10%; float:none;" class="alert alert-info">No one in control</span>
</div>
<div id="applet_container" class="disabledbutton"></div>
<footer>
    <% include ../partials/footer %>
</footer>
</body>
</html>